#!/bin/bash

# Step 1: Add Helm repo
helm repo add vmware-tanzu https://vmware-tanzu.github.io/helm-charts
helm repo update

# Step 2: Create namespace
kubectl create namespace velero

# Step 3: Create credentials secret (replace with your actual keys)
kubectl create secret generic cloud-credentials \
  --namespace velero \
  --from-literal cloud='[default]
aws_access_key_id=YOUR_ACCESS_KEY_ID
aws_secret_access_key=YOUR_SECRET_ACCESS_KEY'

# Step 4: Update the values file with your bucket and region
sed -i 's/your-velero-backup-bucket/actual-bucket-name/g' velero-values.yaml
sed -i 's/us-west-2/your-aws-region/g' velero-values.yaml

# Step 5: Install with Helm using values file
helm install velero vmware-tanzu/velero \
  --namespace velero \
  --values velero-values.yaml

# Step 6: Wait for deployment
kubectl wait --for=condition=available --timeout=300s deployment/velero -n velero

# Step 7: Verify installation
kubectl get pods -n velero
helm status velero -n velero

echo "Velero installation complete!"
echo "Check status with: kubectl get pods -n velero"
