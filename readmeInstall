#!/bin/bash

# 1. Create S3 bucket for Velero backups
BUCKET_NAME="your-velero-backup-bucket-$(date +%s)"
AWS_REGION="us-west-2"  # Change to your region

aws s3 mb s3://$BUCKET_NAME --region $AWS_REGION

# 2. Create IAM policy for Velero
cat > velero-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeVolumes",
                "ec2:DescribeSnapshots",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:CreateSnapshot",
                "ec2:DeleteSnapshot"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:PutObject",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts"
            ],
            "Resource": [
                "arn:aws:s3:::$BUCKET_NAME/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::$BUCKET_NAME"
            ]
        }
    ]
}
EOF

# 3. Create IAM policy
aws iam create-policy \
    --policy-name VeleroAccessPolicy \
    --policy-document file://velero-policy.json

# 4. Create IAM user for Velero
aws iam create-user --user-name velero

# 5. Attach policy to user
aws iam attach-user-policy \
    --policy-arn arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):policy/VeleroAccessPolicy \
    --user-name velero

# 6. Create access keys
aws iam create-access-key --user-name velero

echo "Save the AccessKeyId and SecretAccessKey from above output!"
echo "Bucket created: $BUCKET_NAME"

_____________________HELM REpO COMMAND FOR INSTALL
#!/bin/bash

# Step 1: Add Helm repo
helm repo add vmware-tanzu https://vmware-tanzu.github.io/helm-charts
helm repo update

# Step 2: Create namespace
kubectl create namespace velero

# Step 3: Create credentials secret (replace with your actual keys)
kubectl create secret generic cloud-credentials \
  --namespace velero \
  --from-literal cloud='[default]
aws_access_key_id=YOUR_ACCESS_KEY_ID
aws_secret_access_key=YOUR_SECRET_ACCESS_KEY'

# Step 4: Update the values file with your bucket and region
sed -i 's/your-velero-backup-bucket/actual-bucket-name/g' velero-values.yaml
sed -i 's/us-west-2/your-aws-region/g' velero-values.yaml

# Step 5: Install with Helm using values file
helm install velero vmware-tanzu/velero \
  --namespace velero \
  --values velero-values.yaml

# Step 6: Wait for deployment
kubectl wait --for=condition=available --timeout=300s deployment/velero -n velero

# Step 7: Verify installation
kubectl get pods -n velero
helm status velero -n velero

echo "Velero installation complete!"
echo "Check status with: kubectl get pods -n velero"
